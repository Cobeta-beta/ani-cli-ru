# Руководство для разработчиков

## Суть проекта
Этот проект - это набор модулей-парсеров и их разработки для отправки запросов на источники с помощью **requests** 
с дальнейшей получением необходимых данных с помощью регулярных выражений. 

BeautifulSoap4 упросил бы реализацию, но он умышленно не используется для понижения зависимостей от сторонних 
модулей, так как библиотеку для изначального замысла предполагается устанавливать в глобальный доступ пакетов pip.

## Краткая история разработки

Данное решение изначально было скриптом на 300 строк кода в CLI управлением для 
получения прямых ссылок с дальнейшей передачей на видео в mpv плеер на базе парсера источника animego.

Но оказалось, что такая реализация не гарантирует 100% работоспособность и из-за этого логика проекта была переписана,
для добавления альтернативных источников получения видео, для CLI решения и сказалась реализация high-level архитектуры.
Список доступных озучек в объекте Episode с Player могут отличаться. 

Благодаря такому подходу, можно парсеры использовать отдельно от CLI скрипта. 

## Схема работы вызовов высокоуровневого API:
```
            anime = Anime()
                  |
                  v
                anime
                  |  # на выбор: поиск по строке или онгоингов
                  v
         ----------------------     
         |                    |
anime.search(query)     anime.ongoing()
        |                     |
List[AnimeResult]       List[Ongoing]
        |                     |
AnimeResult.episodes()  Ongoing.episodes()
        |                     |
        -----------------------
                   |
              List[Episode]
                   |
              Episode.player()
                   |
              List[Player]
                   |
            Player.get_video()
                   
                
           

```

## High-level

Все вызовы проходят через получаемые объекты, так гарантируется максимальная совместимость реализации,
независимо от источника.

```python
from anicli_ru.extractors import animego

# поиск по строке
results = animego.Anime().search("experiments lain")
# получение прямой ссылки на первый результат, первого эпизода и первого видео
print(results[0].episodes()[0].player()[0].get_video())
# получени онгоингов
results = animego.Anime().ongoing()
# получение первого онгоинга, первого эпизода и первого видео
print(results[0].episodes()[0].player()[0].get_video())
```

Также можно загружать динамически парсер через встроенный loader:
```python
from anicli_ru import loader

# импорт готового реализованного парсера (без префикса .py, обратите внимание!)
extractor = loader.import_extractor("anicli_ru/extractors/anilibria")
# импорт своего парсера
extractor2 = loader.import_extractor("my_extractor")

results = extractor.Anime().search("Зомбиленд")
# ...

```
# Low-level
В CLI скрипте парсеры импортируются из каталога `anicli_ru/extractors`, игнорируя файлы, которые начинаются на двойное 
подчёркивание `__` и которые **не имеют расширение .py**.


Парсер обязательно должен иметь следующие классы, иначе вернёт ошибку **AttributeError**.
Шаблон можно скопировать из файла `anicli_ru/extractors/__template__.py`
```python
from anicli_ru.base import *


class Anime(BaseAnimeHTTP):
    # ...

class AnimeResult(BaseAnimeResult):
    # ...

class Ongoing(BaseOngoing):
    #...

class Player(BasePlayer):
    # ...

class Episode(BaseEpisode):
    # ...

```
Также через него нельзя импортировать динамически любые другие модули/библиотеки отличные от структуры выше, 
иначе вернёт **AttributeError**

```python
from anicli_ru import loader

extractor = loader.import_extractor("anicli_ru/extractors/anilibria")  # ok
extractor2 = loader.import_extractor("math")  # AttributeError
```
## Архитектура Объектов парсеров

Если текст будет не очень понятен, то смотрите готовые реализации парсеров в директории `anicli_ru/extractors`

### Структура запросов

Все запросы идут через класс **Anime**, который наследуется от **BaseAnimeHTTP**.

**BaseAnimeHTTP** - синглтон класс, в нём заложена основная логика хранения сессии с cookie файлами и прочими 
настройками `requests.Session` объекта. 

В классе **Anime** минимально необходимо только прописать ссылки, куда отправлять запросы и возвращать объект, 
вызываемый через классовый метод **parse(<ответ от запроса>)**. 

Опционально можно добавить дополнительные методы, которые будут работать внутри этого класса для настройки нужного
поведения.

### Структура возвращаемых объектов

Основные возвращаемые объекты наследуются от базовых классов:

**BaseParser** - основной объект-парсер, получает данные с html документа с помощью регулярных выражений. 

На основе заданного словаря REGEX: [**<имя_аттрибута>**: **<регулярное выражение>**] ищет результаты и 
присваивает **<имя_аттрибута>** результат, найденный регулярным выражением. Возвращает список объектов, сформированный
данным аттрибутом. Возвращает список распарсенных объектов. **см. реализацию 
[animego.py](anicli_ru/extractors/animego.py), [animania.py](anicli_ru/extractors/animania.py)**


**BaseJsonParser** - объект-парсер, получает данные из json, и присваивает аттрибутам значения ключей, заданных в
последовательности **KEYS**. Возвращает список распарсенных объектов. **см. реализацию 
[anilibria.py](anicli_ru/extractors/anilibria.py)**


Если данные готовые классы не подходят для написания своего парсера, то можно от них наследоваться 
и изменить логику поведения, например, изменением классовго методоа **parse()**. 

Также, для более удобной работы рекомендуется нужные аттрибуты класса затайпхинтить.

**ResultList** - UserList, имеет дополнительный метод print_enumerate(*args), который выведет в консоль все 
найденные объекты по номерам по шаблону `[i] *(getattr(obj, arg) for arg in args)` если переданы аргументы,
иначе вызовет магический метод объекта `__str__` и выведет по шаблону `[i] obj`. 

Если список пуст, напечатает `Results not found!`

Готовые объекты, унаследованные от **BaseParser**


**AnimeResult** - объект, получаемый Anime().search(q)


**Ongoing** - объект, полученный из Anime().ongoing()


**Episode** - объект, полученный из **Ongoing** или **AnimeResult** через метод **episode()**


**Player** - объект, полученный из **Episode** через метод **player()**


